#     Copyright (C) 1998  Thomas Roessler <roessler@guug.de>
#     Copyright (C) 1999  Roland Rosenfeld <roland@spinnaker.de>
# 
#     This program is free software; you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation; either version 2 of the License, or
#     (at your option) any later version.
# 
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
# 
#     You should have received a copy of the GNU General Public License
#     along with this program; if not, write to the Free Software
#     Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
# $Id$

CC=@CC@
LDFLAGS=@LDFLAGS@
CFLAGS=@CFLAGS@
CPPFLAGS=@CPPFLAGS@
DEFS=@DEFS@
INSTALL=@INSTALL@
MODULES=@MODULES@
DOTLOCKBASE=@DOTLOCKBASE@
DOTLOCK_TARGET=@DOTLOCK_TARGET@
PERL=@PERL@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
srcdir=@srcdir@
libdir=@libdir@
mandir=@mandir@
sysconfdir=@sysconfdir@

ALL=Makefile lbdbq lbdb_lib lbdb-fetchaddr lbdb-munge fetchaddr munge \
	nodelist2lbdb lbdbq.man lbdb-fetchaddr.man nodelist2lbdb.man \
	$(MODULES) $(DOTLOCK_TARGET)

all: $(ALL)

install: all
	$(srcdir)/mkinstalldirs $(bindir)
	$(srcdir)/mkinstalldirs $(libdir)
	$(srcdir)/mkinstalldirs $(mandir)
	$(srcdir)/mkinstalldirs $(mandir)/man1
	$(INSTALL) -m 755 fetchaddr $(libdir)
	$(INSTALL) -m 755 lbdbq $(bindir)
	$(INSTALL) -m 755 lbdb-fetchaddr $(bindir)
	$(INSTALL) -m 755 lbdb-munge $(libdir)
	$(INSTALL) -m 755 lbdb_lib $(libdir)
	$(INSTALL) -m 755 munge $(libdir)
	if [ "$(PERL)" != "no" ]; then \
		$(INSTALL) -m 755 nodelist2lbdb $(bindir); \
		$(INSTALL) -m 644 nodelist2lbdb.man \
			$(mandir)/man1/nodelist2lbdb.1; \
	fi
	for i in $(MODULES) ; do $(INSTALL) -m 755 $$i $(libdir) ; done
	$(INSTALL) -m 644 lbdbq.man $(mandir)/man1/lbdbq.1
	$(INSTALL) -m 644 lbdb-fetchaddr.man $(mandir)/man1/lbdb-fetchaddr.1
	$(INSTALL) -m 644 lbdb.rc $(sysconfdir)/lbdb.rc
	if [ "$(DOTLOCK_TARGET)" != "" ]; then \
		$(INSTALL) -m 755 lbdb_dotlock $(bindir); \
		$(INSTALL) -m 644 dotlock.man $(mandir)/man1/lbdb_dotlock.1; \
	fi

fetchaddr: $(srcdir)/fetchaddr.o $(srcdir)/rfc822.o $(srcdir)/helpers.o  \
	$(srcdir)/rfc2047.o
	$(CC) $(CFLAGS) $(LDFLAGS) $? -o $@

fetch: $(srcdir)/fetch.sh

query: $(srcdir)/query.sh

lbdb-query: $(srcdir)/lbdb-query.sh

nodelist2lbdb: $(srcdir)/nodelist2lbdb.pl
	cat nodelist2lbdb.pl > $@

lbdb_dotlock: $(srcdir)/dotlock.o
	$(CC) $(CFLAGS) $(LDFLAGS) $? -o $@

dotlock.o: $(srcdir)/dotlock.h $(srcdir)/dotlock.c

munge: munge.awk
	cat munge.awk > $@
	chmod a+x $@

clean:
	-rm -f *.o *~ $(ALL) munge.awk nodelist2lbdb.pl

distclean: clean
	-rm -f config.status config.cache config.log Makefile
	-rm -f *.sh

Makefile: Makefile.in
	./config.status

%.sh: %.sh.in
	./config.status

%.pl: %.pl.in
	./config.status

%.awk: %.awk.in
	./config.status

%.man: %.man.in
	sed -e 's!@''libdir@!$(libdir)!' \
	    -e 's!@''sysconfdir@!$(sysconfdir)!' \
	    -e 's!@''dotlock@!$(DOTLOCKBASE)!' $@.in > $@

%.o: %.c
	$(CC) $(CFLAGS) $(DEFS) -c $<
